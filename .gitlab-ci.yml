
stages:
  - codegen
  - build
  - benchmark
  - test
  - package

codegen-job:
  tags:
    - matlab
  stage: codegen
  script:
    - "make asr.zip"
  artifacts:
    paths:
      - asr.zip

build-job:
  tags:
    - pi
  stage: build
  dependencies:
    - codegen-job
  script:
    - "unzip -o -d codegen asr.zip"
    - "touch codegen/.directory" 
    - "make"
  artifacts:
    paths:
      - asr.so

package-x86-job:
  tags:
    - x86
  stage: package
  dependencies:
    - build-job
  script:
    - "make deb"
  artifacts:
    paths:
      - "asr_*_*.deb"

package-arm-job:
  tags:
    - arm
  stage: package
  dependencies:
    - build-job
  script:
    - "make deb"
  artifacts:
    paths:
      - "asr_*_*.deb"

benchmark-job:
  tags:
    - pi
  stage: benchmark
  script:
    - "unzip -o asr.zip -d codegen"
    - "touch codegen/.directory"
    - "make benchmark"
    - "ulimit -c unlimited"
    - "./benchmark --benchmark_out_format=console --benchmark_out=benchmark.log"
  artifacts:
    paths:
      - "benchmark.log"
      - "benchmark"

test-job:
  stage: test
  tags:
    - pi
  script:
    - "unzip -o asr.zip -d codegen"
    - "touch codegen/.directory"
    - "make test"
    - "./test"
